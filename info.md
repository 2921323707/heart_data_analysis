# MIT-BIH心律失常数据库使用指南

## 目录
1. [心电图基础知识](#心电图基础知识)
2. [MIT-BIH数据集介绍](#mit-bih数据集介绍)
3. [数据格式说明](#数据格式说明)
4. [常见心律失常类型](#常见心律失常类型)
5. [数据预处理方法](#数据预处理方法)
6. [深度学习模型架构](#深度学习模型架构)
7. [使用说明](#使用说明)

---

## 心电图基础知识

### 什么是心电图（ECG）？

心电图（Electrocardiogram, ECG）是通过记录心脏电活动来评估心脏功能的医学检查方法。心脏每次跳动时，都会产生电信号，这些信号可以被体表的电极检测并记录下来，形成心电图波形。

### 正常心电图的组成

一个正常的心电图周期包含以下几个主要波形：

#### 1. **P波（P Wave）**
- **位置**：心电周期的开始
- **含义**：代表心房的去极化（收缩）
- **持续时间**：通常0.08-0.12秒
- **形态**：小而圆滑，向上或向下的凸起

#### 2. **QRS波群（QRS Complex）**
- **位置**：P波之后
- **含义**：代表心室的去极化（收缩）
- **持续时间**：通常0.06-0.10秒
- **形态**：由三个部分组成：
  - **Q波**：第一个向下的波（如果存在）
  - **R波**：向上的尖峰（最明显）
  - **S波**：R波后的向下波
- **特点**：这是心电图中最明显、最尖锐的部分

#### 3. **T波（T Wave）**
- **位置**：QRS波群之后
- **含义**：代表心室的复极化（舒张）
- **持续时间**：通常0.10-0.25秒
- **形态**：圆滑的向上或向下凸起

#### 4. **其他组成部分**
- **PR间期**：从P波开始到QRS波群开始的间隔，正常0.12-0.20秒
- **ST段**：QRS波群结束到T波开始的水平段
- **QT间期**：从QRS波群开始到T波结束的间隔

### 心率计算

心率（Heart Rate, HR）可以通过测量两个连续R波之间的间隔（RR间期）来计算：

```
心率 (bpm) = 60 / RR间期 (秒)
```

正常成人的静息心率通常在60-100次/分钟（bpm）之间。

---

## MIT-BIH数据集介绍

### 数据集概述

MIT-BIH心律失常数据库（MIT-BIH Arrhythmia Database）是由麻省理工学院（MIT）和贝斯以色列医院（Beth Israel Hospital）联合创建的心电图数据库，是心律失常检测算法研究和评估的标准数据集。

### 数据集特点

- **记录数量**：48条记录
- **记录编号**：
  - 100-124：随机选择的23条记录（代表临床常见情况）
  - 200-234：精心选择的25条记录（包含罕见但重要的心律失常）
- **记录时长**：每条记录约30分钟
- **采样率**：360 Hz（每秒360个采样点）
- **通道数**：每条记录通常包含2个导联（通道）
  - 通道1：改良的肢体导联II（MLII）
  - 通道2：改良的胸导联V1（偶尔是V2、V5或V4）
- **数据格式**：11位ADC，8位差分编码存储
- **标注**：每条记录都包含由心脏病专家标注的心跳类型和注释

### 数据采集背景

- **采集时间**：1975-1979年
- **来源**：从4000多条长期Holter记录中选择
- **受试者**：25名男性（32-89岁）和22名女性（23-89岁）
- **应用场景**：约60%的记录来自住院患者

### 数据文件格式

MIT-BIH数据集使用WFDB（Waveform Database）格式，每条记录包含三个文件：

1. **.hea文件（头文件）**
   - 包含记录的元数据信息
   - 采样率、信号长度、通道数、信号名称等

2. **.dat文件（数据文件）**
   - 存储实际的ECG信号数据
   - 二进制格式，需要专门的库读取

3. **.atr文件（注释文件）**
   - 包含R波位置和心跳类型标注
   - 由心脏病专家手动标注

---

## 数据格式说明

### 信号数据格式

- **采样率**：360 Hz
- **信号长度**：每条记录约650,000个采样点（约30分钟）
- **数据范围**：ADC值范围0-2047，对应±5mV的电压范围
- **存储格式**：8位差分编码（节省存储空间）

### 注释格式

每个注释包含以下信息：
- **样本位置**：R波在信号中的采样点位置
- **符号**：心跳类型代码（如N、V、A等）
- **辅助注释**：额外的注释信息

### 心跳类型代码

MIT-BIH数据库使用标准的心跳类型符号：

| 符号 | 英文全称 | 中文名称 | 说明 |
|------|---------|---------|------|
| N | Normal beat | 正常心跳 | 正常窦性心律 |
| L | Left bundle branch block beat | 左束支传导阻滞 | 左束支传导异常 |
| R | Right bundle branch block beat | 右束支传导阻滞 | 右束支传导异常 |
| A | Atrial premature beat | 房性早搏 | 心房提前收缩 |
| V | Premature ventricular contraction | 室性早搏 | 心室提前收缩 |
| / | Paced beat | 起搏心跳 | 心脏起搏器产生的心跳 |
| E | Ventricular escape beat | 室性逸搏 | 心室自主节律 |
| a | Fusion of atrial and normal | 融合的房性早搏 | 房性早搏与正常心跳融合 |
| J | Nodal (junctional) premature beat | 交界性早搏 | 房室交界区提前收缩 |
| S | Supraventricular premature beat | 室上性早搏 | 室上性异常心跳 |

---

## 常见心律失常类型

### 1. 正常心跳（Normal Beat, N）

- **特征**：规律的P波、QRS波群和T波
- **RR间期**：相对稳定
- **临床意义**：健康心脏的正常表现

### 2. 左束支传导阻滞（Left Bundle Branch Block, L）

- **特征**：
  - QRS波群增宽（>0.12秒）
  - V1导联呈rS型或QS型
  - I、aVL、V5、V6导联QRS波群增宽、切迹
- **临床意义**：可能表示心脏传导系统异常

### 3. 右束支传导阻滞（Right Bundle Branch Block, R）

- **特征**：
  - QRS波群增宽
  - V1导联呈rsR'型（M型）
  - I、V6导联S波增宽
- **临床意义**：可能表示右束支传导异常

### 4. 房性早搏（Atrial Premature Beat, A）

- **特征**：
  - 提前出现的P波，形态可能异常
  - QRS波群通常正常（除非伴有束支传导阻滞）
  - 代偿间歇不完全
- **临床意义**：可能表示心房异常，通常良性

### 5. 室性早搏（Premature Ventricular Contraction, V）

- **特征**：
  - 提前出现的宽大畸形QRS波群（>0.12秒）
  - 没有相关的P波
  - T波方向与QRS主波方向相反
  - 代偿间歇完全
- **临床意义**：可能表示心室异常，需要关注

### 6. 其他类型

- **起搏心跳（Paced Beat, /）**：由心脏起搏器产生的心跳，通常有明显的起搏信号
- **室性逸搏（Ventricular Escape Beat, E）**：心室自主节律，通常出现在心率过慢时
- **交界性早搏（Junctional Premature Beat, J）**：房室交界区提前收缩

---

## 数据预处理方法

### 1. 信号去噪

ECG信号在采集过程中容易受到各种噪声干扰，包括：
- **工频干扰**：50Hz或60Hz的电源干扰
- **肌电干扰**：肌肉活动产生的电信号
- **基线漂移**：缓慢变化的基线偏移
- **运动伪影**：电极移动产生的伪影

#### 去噪方法

**小波去噪（Wavelet Denoising）**
- 使用小波变换将信号分解为不同频率成分
- 对细节系数进行阈值处理，去除噪声
- 重构信号得到去噪后的ECG

**带通滤波（Bandpass Filtering）**
- 使用Butterworth滤波器
- 通常保留0.5-40 Hz的频率范围
- 去除高频噪声和低频基线漂移

### 2. 心拍分割

根据R波峰值位置，将连续的ECG信号分割成单个心拍：

- **窗口长度**：通常每个心拍取R波前后各180个采样点（共360个点，约1秒）
- **R波检测**：使用注释文件中的R波位置信息
- **边界处理**：确保R波位置在有效范围内，避免边界效应

### 3. 特征提取

从每个心拍中提取特征用于分类：

**时域特征**：
- 均值、标准差
- 最大值、最小值
- RR间期（与前一个心跳的间隔）

**频域特征**：
- 快速傅里叶变换（FFT）系数
- 功率谱密度

**形态特征**：
- P波、QRS波群、T波的幅度和持续时间
- 波形复杂度指标

### 4. 数据标准化

对提取的特征进行标准化处理，以提高模型训练的稳定性：

**Z-score标准化**：
```
标准化值 = (原始值 - 均值) / 标准差
```

这样可以：
- 消除不同特征之间的量纲差异
- 加速模型收敛
- 提高训练稳定性

---

## 深度学习模型架构

### 1. CNN模型（卷积神经网络）

**架构特点**：
- 使用1D卷积层提取局部特征
- 通过池化层降低特征维度
- 全连接层进行最终分类

**层次结构**：
1. 输入层：接收长度为360的ECG信号
2. 卷积层1：32个卷积核，提取基础特征
3. 池化层1：降维
4. 卷积层2：64个卷积核，提取更高级特征
5. 池化层2：进一步降维
6. 卷积层3-4：提取更深层特征
7. 全连接层：进行分类决策

**优势**：
- 能够自动学习ECG信号的特征表示
- 对局部模式敏感，适合检测QRS波群等特征
- 训练速度快，参数相对较少

### 2. CNN-LSTM混合模型

**架构特点**：
- CNN部分提取空间特征（信号形态）
- LSTM部分捕获时序依赖（心跳间的关系）

**层次结构**：
1. CNN特征提取：多个卷积层提取局部特征
2. LSTM时序建模：处理特征序列，捕获长期依赖
3. 全连接层：进行分类

**优势**：
- 结合了CNN和LSTM的优点
- 能够同时考虑心拍内部形态和心跳间关系
- 适合处理复杂的心律失常模式

### 3. 训练策略

**损失函数**：
- 交叉熵损失（Cross-Entropy Loss）
- 适合多分类任务

**优化器**：
- Adam优化器
- 自适应学习率，收敛速度快

**正则化**：
- Dropout：防止过拟合
- 权重衰减：L2正则化
- 批量归一化：稳定训练过程

**学习率调度**：
- ReduceLROnPlateau：当验证损失不再下降时自动降低学习率

**早停机制**：
- 当验证准确率连续多轮未提升时停止训练
- 防止过拟合，节省训练时间

---

## 使用说明

### 环境配置

1. **安装Python依赖**：
```bash
pip install -r requirements.txt
```

主要依赖包：
- `wfdb`: 读取MIT-BIH数据
- `torch`: PyTorch深度学习框架
- `numpy`: 数值计算
- `scipy`: 科学计算（信号处理）
- `matplotlib`: 数据可视化
- `scikit-learn`: 机器学习工具
- `pywavelets`: 小波变换
- `seaborn`: 统计可视化
- `tqdm`: 进度条

### 数据准备

1. 确保`heart_data`文件夹包含MIT-BIH数据集文件
2. 数据文件应包含：
   - `.dat`文件：信号数据
   - `.hea`文件：头文件
   - `.atr`文件：注释文件

### 运行训练

**基本使用**：
```bash
python train.py
```

**自定义参数**：
可以在`train.py`的`main()`函数中修改配置参数：
- `max_records`: 最大加载记录数（None表示全部）
- `target_classes`: 目标分类类别
- `batch_size`: 批次大小
- `num_epochs`: 训练轮数
- `model_type`: 模型类型（'cnn'或'cnn_lstm'）

### 数据可视化

**可视化ECG信号**：
```python
from data_loader import MITBIHLoader
from visualize import ECGVisualizer

# 加载数据
loader = MITBIHLoader('heart_data')
signal, record_info, ann_info = loader.load_record('100')

# 可视化
visualizer = ECGVisualizer(fs=360)
visualizer.plot_signal(signal[:, 0], title="ECG信号示例")
visualizer.plot_signal_with_rpeaks(signal[:, 0], ann_info['sample'], 
                                   title="ECG信号与R波标记")
```

### 结果文件

训练完成后会生成以下文件：
- `best_model.pth`: 最佳模型权重
- `training_curves.png`: 训练过程曲线
- `confusion_matrix.png`: 混淆矩阵

### 评估指标

模型评估使用的指标：
- **准确率（Accuracy）**：正确分类的样本比例
- **精确率（Precision）**：预测为正例中真正为正例的比例
- **召回率（Recall）**：真正例中被正确预测的比例
- **F1分数（F1-Score）**：精确率和召回率的调和平均

### 注意事项

1. **数据不平衡**：不同类别的心跳数量可能差异很大，可能需要使用类别权重或采样策略
2. **计算资源**：训练深度学习模型需要一定的计算资源，建议使用GPU加速
3. **超参数调优**：根据实际数据特点调整学习率、批次大小等超参数
4. **数据质量**：确保数据文件完整，避免加载错误

---

## 参考文献

1. Moody, G. B., & Mark, R. G. (2001). The impact of the MIT-BIH Arrhythmia Database. IEEE Engineering in Medicine and Biology Magazine, 20(3), 45-50.

2. MIT-BIH Arrhythmia Database. PhysioNet. https://physionet.org/content/mitdb/1.0.0/

3. Goldberger, A. L., et al. (2000). PhysioBank, PhysioToolkit, and PhysioNet: Components of a new research resource for complex physiologic signals. Circulation, 101(23), e215-e220.

---

## 附录：常见问题

**Q: 为什么有些记录无法加载？**
A: 可能是文件损坏或格式不完整。检查数据文件是否完整，确保`.dat`、`.hea`、`.atr`文件都存在。

**Q: 如何选择合适的心拍长度？**
A: 通常选择360个采样点（1秒@360Hz），涵盖一个完整的心跳周期。可根据实际需求调整。

**Q: 模型训练需要多长时间？**
A: 取决于数据量、模型复杂度和硬件配置。通常单个epoch需要几分钟到几十分钟不等。

**Q: 如何提高模型准确率？**
A: 可以尝试：
- 增加训练数据量
- 调整模型架构（增加层数、通道数）
- 优化超参数（学习率、批次大小）
- 使用数据增强技术
- 处理类别不平衡问题

---

**最后更新**：2024年

**作者**：机器学习工程师

**版本**：1.0

